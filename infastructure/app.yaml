#cloud-config
package_update: true
package_upgrade: true
package_reboot_if_required: true

groups:
  - ubuntu: [root, sys]
  - wmca

packages:
  - git
  - nginx

# Add users to the system. Users are added after groups are added.
users:
  - default
  - name: terraform
    gecos: terraform
    shell: /bin/bash
    primary_group: wmca
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: users, admin
    lock_passwd: false
    ssh-authorized-keys:
      - ${pub_key}

bootcmd:
  - sudo apt-get install certbot
  - apt-get install python3-certbot-nginx

runcmd:
  - /usr/bin/sleep 10
  - /usr/bin/git clone https://github.com/dills122/where-my-cage-at.git app-src
  - /usr/bin/sh ./app-src/deploy.sh
  - /usr/bin/docker update --restart unless-stopped $(docker ps -q)

final_message: 'The system is finally up, after $UPTIME seconds'
